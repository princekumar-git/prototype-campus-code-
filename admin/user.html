<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CampusCode – Manage Users</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ["Poppins", "sans-serif"] },
          colors: {
            primary: {
              50: "#E7F0FA", 100: "#D0E1F5", 200: "#7BA4D0", 300: "#4D84C0",
              400: "#2E5E99", 500: "#1E4A7A", 600: "#0D2440"
            },
            dark: { bg: "#111827", card: "#1F2937", text: "#F9FAFB", border: "#374151" }
          }
        }
      }
    }
  </script>
  <style>
    /* --- Sidebar & Layout CSS (From Dashboard) --- */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    .dark ::-webkit-scrollbar-track { background: #111827; }
    ::-webkit-scrollbar-thumb { background: #7ba4d0; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #2e5e99; }

    .sidebar { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; }
    .sidebar.collapsed { width: 5rem; }
    .sidebar.collapsed .nav-item { justify-content: center; padding-left: 0; padding-right: 0; }
    .sidebar.collapsed .nav-item i { margin-right: 0; font-size: 1.25rem; }
    .sidebar.collapsed .nav-item span { display: none; }
    .sidebar.collapsed .logo-text { display: none; }
    .sidebar.collapsed .bottom-menu span { display: none; }
    .sidebar.collapsed .bottom-menu .nav-item { justify-content: center; }

    .nav-item { transition: all 0.2s ease; position: relative; display: flex; align-items: center; padding: 0.75rem 1rem; margin-bottom: 0.25rem; color: #374151; border-radius: 0.5rem; cursor: pointer; white-space: nowrap; }
    .nav-item:hover { background-color: #f3f4f6; }
    .dark .nav-item { color: #d1d5db; }
    .dark .nav-item:hover { background-color: #374151; }
    .nav-item.active { background-color: #d0e1f5; color: #1e4a7a; }
    .dark .nav-item.active { background-color: #1e4a7a; color: #ffffff; }
    .nav-item.active::before { content: ""; position: absolute; left: 0; top: 50%; transform: translateY(-50%); height: 60%; width: 4px; background-color: #2e5e99; border-radius: 0 4px 4px 0; }
    .dark .nav-item.active::before { background-color: #60a5fa; }
    .nav-item i { width: 1.5rem; text-align: center; margin-right: 0.75rem; font-size: 1.1rem; flex-shrink: 0; }
    .nav-item span { font-size: 0.875rem; font-weight: 500; }

    /* --- Existing Page Specific Styles --- */
    :root { --bg-color: #f9fafb; --bg-card: #ffffff; --bg-header: #ffffff; --border-color: #e5e7eb; }
    .dark { --bg-color: #111827; --bg-card: #1f2937; --bg-header: #1f2937; --border-color: #374151; }

    body { background-color: var(--bg-color); transition: all 0.3s ease; }
    .bg-theme-card { background-color: var(--bg-card); }
    .bg-theme-header { background-color: var(--bg-header); }
    .border-theme-default { border-color: var(--border-color); }
    .tab-active { background-color: #1E4A7A !important; color: white !important; }
    .modal-tab-active { border-bottom: 3px solid #1E4A7A; color: #1E4A7A; font-weight: 700; background: rgba(30, 74, 122, 0.05); }
    
    .table-container { 
        height: calc(100vh - 430px); 
        min-height: 300px;
        overflow-x: auto; 
        position: relative;
    }
    
    thead th { 
        position: sticky; top: 0; z-index: 20; background-color: #f8fafc; 
        color: #64748b; border-bottom: 2px solid #e2e8f0; white-space: nowrap;
        font-size: 10px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.05em;
    }
    
    .dark thead th { background-color: #1e293b; color: #94a3b8; border-bottom: 2px solid #334155; }
    tbody tr { transition: background-color 0.2s; white-space: nowrap; }
  </style>
</head>

<body class="font-sans min-h-screen transition-colors duration-200 bg-gray-50 dark:bg-gray-900">

<div class="flex h-screen overflow-hidden">
  
  <aside id="mainSidebar" class="sidebar w-64 bg-white dark:bg-gray-800 shadow-sm border-r border-gray-200 dark:border-gray-700 flex flex-col h-screen flex-shrink-0 transition-colors duration-200 z-50">
      <div class="p-6 flex-shrink-0 flex items-center justify-between h-[88px]">
          <h1 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center gap-2 overflow-hidden whitespace-nowrap">
              <i class="fas fa-code text-primary-500 text-2xl flex-shrink-0"></i>
              <span class="logo-text transition-all duration-300 opacity-100 w-auto">CampusCode</span>
          </h1>
          <button id="sidebarToggleBtn" class="p-1.5 rounded-lg text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-primary-500 transition-colors focus:outline-none">
              <i class="fas fa-chevron-left transition-transform duration-300"></i>
          </button>
      </div>

      <nav class="flex-1 px-4 space-y-1 overflow-y-auto mt-2">
          <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a>
          <a href="program.html" class="nav-item"><i class="fa-solid fa-layer-group"></i><span>Programs</span></a>
          <a href="contest.html" class="nav-item"><i class="fas fa-trophy"></i><span>Contests</span></a>
          <a href="manage_user.html" class="nav-item active"><i class="fa-solid fa-users"></i><span>User</span></a>
          <a href="update-report.html" class="nav-item"><i class="fas fa-file-invoice"></i><span>Reports</span></a>
          <a href="profile.html" class="nav-item"><i class="fas fa-user"></i><span>Profile</span></a>
      </nav>

      <div class="p-4 space-y-1 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 flex-shrink-0 bottom-menu">
          <a href="help_support.html" class="nav-item"><i class="far fa-question-circle"></i><span>Help & Support</span></a>
          <div id="settingsTrigger" class="nav-item"><i class="fas fa-cog"></i><span>Settings</span></div>
      </div>
  </aside>

  <div class="flex-1 overflow-y-auto">
    
    <header class="bg-white dark:bg-gray-800 shadow-sm transition-colors duration-200 sticky top-0 z-40">
        <div class="px-8 py-3 flex justify-between items-center">
            
            <div class="flex-1 max-w-2xl flex items-center gap-4">
                <div class="relative flex items-center w-full">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" id="searchInput" oninput="render()"
                        class="block w-full pl-10 pr-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm text-gray-900 dark:text-gray-100 placeholder-gray-500 focus:ring-2 focus:ring-primary-400 focus:border-transparent transition-all"
                        placeholder="Search by name, ID or email..." />
                </div>
            </div>

            <div class="ml-4 flex items-center gap-3 relative">
                <button id="themeToggleBtn" class="p-2 rounded-full text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none transition-transform active:scale-95">
                    <i class="fas fa-moon text-xl"></i>
                </button>
                
                <div class="relative">
                    <button id="notificationBtn" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 focus:outline-none">
                        <i class="fas fa-bell text-xl"></i>
                        <span class="absolute top-0 right-0 h-2 w-2 rounded-full bg-red-500 border-2 border-white dark:border-gray-800"></span>
                    </button>
                    <div id="notifDropdown" class="hidden absolute right-0 mt-3 w-80 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-100 dark:border-gray-700 z-50">
                        <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
                            <h3 class="font-semibold text-gray-800 dark:text-white text-sm">Notifications</h3>
                            <button class="text-xs text-primary-500 font-medium hover:text-primary-600">Mark all read</button>
                        </div>
                        <div class="max-h-64 overflow-y-auto">
                            <div class="p-3 hover:bg-gray-50 dark:hover:bg-gray-700 border-b border-gray-100 dark:border-gray-700 cursor-pointer">
                                <p class="text-xs font-semibold text-primary-500">New Registration</p>
                                <p class="text-xs text-gray-600 dark:text-gray-300 mt-1">Student registered in CSE Dept.</p>
                            </div>
                            <div class="p-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                                <p class="text-xs font-semibold text-yellow-500">Contest Alert</p>
                                <p class="text-xs text-gray-600 dark:text-gray-300 mt-1">New college-level contest created.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="toggleProfile()" class="ml-2 flex items-center gap-3 p-1 pr-3 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                     <div class="h-9 w-9 rounded-full bg-primary-500 flex items-center justify-center text-white font-bold text-sm">RK</div>
                     <span class="text-sm font-medium text-gray-700 dark:text-gray-200 hidden sm:block">Raj Kumar</span>
                </button>
            </div>
        </div>
    </header>

    <main class="p-8 space-y-6">
        <div class="flex justify-between items-end">
            <div>
                <h2 class="text-3xl font-bold tracking-tight dark:text-white">User Directory</h2>
                <p class="text-sm text-gray-500 mt-1 font-medium">Manage students, faculty, and enrollment requests.</p>
            </div>
            <div class="flex gap-3">
                <button onclick="exportToExcel()" class="px-6 py-3 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 text-sm font-bold rounded-2xl shadow-sm hover:bg-gray-50 transition-all flex items-center gap-2">
                    <i class="fas fa-download text-primary-500"></i> Export List
                </button>
                <button id="onboardBtn" onclick="openAddModal()" class="px-7 py-3 bg-primary-500 hover:bg-primary-600 text-white text-sm font-bold rounded-2xl shadow-lg transition-all">+ Onboard Member</button>
            </div>
        </div>

        <div class="flex bg-theme-card p-1.5 rounded-2xl border border-theme-default shadow-sm w-fit">
            <button onclick="setTab('student')" id="tabStudent" class="px-10 py-3 rounded-xl text-sm font-bold transition-all tab-active">Students</button>
            <button onclick="setTab('faculty')" id="tabFaculty" class="px-10 py-3 rounded-xl text-sm font-bold text-gray-500 transition-all">Faculty</button>
            <button onclick="setTab('requests')" id="tabRequests" class="px-10 py-3 rounded-xl text-sm font-bold text-gray-500 transition-all flex items-center gap-3">
                Requests <span id="requestBadge" class="bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full">0</span>
            </button>
        </div>

        <div id="bulkInviteSection" class="bg-theme-card rounded-3xl border border-theme-default shadow-sm p-6">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-bold dark:text-white">Batch Onboarding</h3>
                    <p class="text-xs text-gray-500 font-medium">Upload Excel file to populate current tab.</p>
                </div>
                <label class="px-6 py-2.5 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 hover:border-primary-400 text-gray-700 dark:text-gray-200 rounded-xl text-xs font-bold cursor-pointer transition-all flex items-center gap-2">
                    <i class="fas fa-file-excel text-green-600"></i>
                    <span>Upload Spreadsheet</span>
                    <input type="file" id="excelUpload" class="hidden" accept=".xlsx, .xls, .csv" onchange="handleExcelUpload(event)">
                </label>
            </div>
        </div>

        <div class="bg-theme-card rounded-3xl border border-theme-default shadow-md overflow-hidden">
            <div class="table-container">
                <table class="w-full text-left" id="mainTable">
                    <thead id="tableHead"></thead>
                    <tbody id="userTableBody" class="divide-y border-theme-default"></tbody>
                </table>
            </div>
            <div id="emptyState" class="p-20 text-center hidden"><p class="font-bold text-gray-500">No records found.</p></div>
        </div>
    </main>
  </div>
</div>

<div id="addModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-[200]">
    <div class="bg-theme-card rounded-[2.5rem] w-full max-w-2xl p-8 border border-theme-default shadow-2xl overflow-y-auto max-h-[90vh]">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold dark:text-white">Onboard Member</h3>
            <button onclick="closeAddModal()" class="text-gray-400 hover:text-red-500 transition-colors"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div class="space-y-4">
            <div class="flex bg-gray-100 dark:bg-gray-800 p-1 rounded-xl mb-4">
                <button onclick="setModalUserType('student')" id="modalTabStudent" class="flex-1 py-2 text-xs font-bold rounded-lg modal-tab-active">Student</button>
                <button onclick="setModalUserType('faculty')" id="modalTabFaculty" class="flex-1 py-2 text-xs font-bold rounded-lg text-gray-500">Faculty</button>
            </div>
            <div class="grid grid-cols-2 gap-4" id="modalFields"></div>
            <div class="flex gap-3 pt-4">
                <button onclick="closeAddModal()" class="flex-1 py-3 bg-gray-100 dark:bg-gray-700 rounded-xl text-xs font-black uppercase text-gray-500">Cancel</button>
                <button onclick="saveUser()" class="flex-1 py-3 bg-primary-500 text-white rounded-xl text-xs font-black uppercase shadow-lg">Save User</button>
            </div>
        </div>
    </div>
</div>

<div id="profileOverlay" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="bg-white dark:bg-gray-800 w-[320px] rounded-3xl overflow-hidden shadow-2xl transform transition-all">
        <div class="bg-[#1e4a7a] p-6 text-center relative h-32">
            <button onclick="toggleProfile()" class="absolute top-4 right-4 text-white/80 hover:text-white">
                <i class="fas fa-times text-lg"></i>
            </button>
            <div class="absolute -bottom-10 left-1/2 -translate-x-1/2">
                <div class="h-20 w-20 rounded-full border-4 border-white dark:border-gray-800 bg-[#1e4a7a] flex items-center justify-center text-white text-2xl font-bold">RK</div>
            </div>
        </div>
        <div class="pt-12 pb-6 px-6 text-center">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white">Raj Kumar</h3>
            <p class="text-xs text-gray-500 flex items-center justify-center gap-1"><i class="fas fa-university"></i> XYZ Institute Admin</p>
            <p class="text-xs text-gray-500 mb-3 flex items-center justify-center gap-1">ID: Faculty_001</p>

            <div class="flex justify-between border-y border-gray-100 dark:border-gray-700 py-4 mb-6">
                <div><p class="text-[10px] font-bold text-primary-400 uppercase">Contest</p><p class="text-lg font-bold dark:text-white">124</p></div>
                <div class="border-x border-gray-100 dark:border-gray-700 px-6"><p class="text-[10px] font-bold text-primary-400 uppercase">Requests</p><p class="text-lg font-bold dark:text-white">42</p></div>
                <div><p class="text-[10px] font-bold text-primary-400 uppercase">Reports</p><p class="text-lg font-bold dark:text-white">1.2k</p></div>
            </div>
            <div class="space-y-1">
                <button class="w-full flex items-center justify-between p-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors group">
                    <div class="flex items-center gap-3"><i class="fas fa-user-circle text-primary-400"></i><span class="text-sm font-medium text-gray-700 dark:text-gray-200">My Profile</span></div>
                    <i class="fas fa-chevron-right text-[10px] text-gray-400 group-hover:translate-x-1 transition-transform"></i>
                </button>
                
                <button class="w-full flex items-center justify-between p-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors group">
                    <div class="flex items-center gap-3"><i class="fas fa-question-circle text-primary-400"></i><span class="text-sm font-medium text-gray-700 dark:text-gray-200">Help & Support</span></div>
                    <i class="fas fa-chevron-right text-[10px] text-gray-400 group-hover:translate-x-1 transition-transform"></i>
                </button>
                <button id="logoutBtn" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 group mt-2 transition-all">
                    <div class="w-8 h-8 rounded-full bg-red-50 dark:bg-red-900/20 text-red-500 dark:text-red-400 flex items-center justify-center">
                        <i class="fas fa-sign-out-alt"></i>
                    </div>
                    <span class="text-sm font-medium text-red-600 dark:text-red-400">Log out</span>
                </button>
            </div>
            <button onclick="toggleProfile()" class="mt-4 text-[10px] font-bold text-gray-400 uppercase hover:text-gray-600 transition-colors">Close</button>
        </div>
    </div>
</div>

<script>
// --- UI Interaction Logic (Sidebar, Notifications, Profile) ---

// Sidebar Toggle
const sidebar = document.getElementById('mainSidebar');
const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
const toggleIcon = sidebarToggleBtn.querySelector('i');

sidebarToggleBtn.addEventListener('click', () => {
    sidebar.classList.toggle('collapsed');
    if (sidebar.classList.contains('collapsed')) {
        toggleIcon.classList.replace('fa-chevron-left', 'fa-chevron-right');
    } else {
        toggleIcon.classList.replace('fa-chevron-right', 'fa-chevron-left');
    }
});

// Notifications
const notificationBtn = document.getElementById('notificationBtn');
const notifDropdown = document.getElementById('notifDropdown');
notificationBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    notifDropdown.classList.toggle('hidden');
});

// Profile Overlay
function toggleProfile() {
    const overlay = document.getElementById('profileOverlay');
    overlay.classList.toggle('hidden');
}

// Global Click (Close Dropdowns/Overlay)
document.addEventListener('click', (e) => {
    if (!notifDropdown.contains(e.target) && !notificationBtn.contains(e.target)) {
        notifDropdown.classList.add('hidden');
    }
    const profileOverlay = document.getElementById('profileOverlay');
    if (e.target === profileOverlay) {
        toggleProfile();
    }
});

// Logout
const logoutBtn = document.getElementById('logoutBtn');
if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
        window.location.href = '../index.html';
    });
}

// Theme Toggle
const themeToggleBtn = document.getElementById('themeToggleBtn');
const themeIcon = themeToggleBtn.querySelector('i');
const html = document.documentElement;

// Initialize Theme
if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    html.classList.add('dark');
    themeIcon.classList.replace('fa-moon', 'fa-sun');
} else {
    html.classList.remove('dark');
    themeIcon.classList.replace('fa-sun', 'fa-moon');
}

themeToggleBtn.addEventListener('click', () => {
    html.classList.toggle('dark');
    if (html.classList.contains('dark')) {
        localStorage.theme = 'dark';
        themeIcon.classList.replace('fa-moon', 'fa-sun');
    } else {
        localStorage.theme = 'light';
        themeIcon.classList.replace('fa-sun', 'fa-moon');
    }
});


// --- Manage Users Logic (Preserved) ---

let activeTab = 'student';
let modalUserType = 'student';

let users = JSON.parse(localStorage.getItem('campusUsers')) || [
    { id: "S-2024-001", name: "Rahul Singh", email: "rahul@xyz.edu", type: "student", program: "B.Tech", year: "3", branch: "CSE", sec: "A", streak: 15, contest: 12, solved: 145, won: 2, collegeRank: 5, globalRank: 1204, level: 12, accuracy: "88%", lastActive: "2 hours ago" },
    { id: "S-2024-042", name: "Priya Sharma", email: "priya@xyz.edu", type: "student", program: "B.Tech", year: "2", branch: "IT", sec: "B", streak: 8, contest: 9, solved: 210, won: 1, collegeRank: 12, globalRank: 4500, level: 9, accuracy: "76%", lastActive: "1 day ago" },
    { id: "S-2024-088", name: "Amitabh Kumar", email: "amitabh@xyz.edu", type: "student", program: "B.Tech", year: "1", branch: "AI", sec: "C", streak: 30, contest: 15, solved: 320, won: 5, collegeRank: 1, globalRank: 890, level: 18, accuracy: "94%", lastActive: "Now" },
    { id: "S-2024-112", name: "Sneha Reddy", email: "sneha@xyz.edu", type: "student", program: "M.Tech", year: "2", branch: "CS", sec: "A", streak: 5, contest: 4, solved: 88, won: 0, collegeRank: 45, globalRank: 12000, level: 5, accuracy: "62%", lastActive: "5 hours ago" },
    { id: "F-1005", name: "Dr. Vikram Seth", email: "vikram@xyz.edu", type: "faculty", designation: "Professor", dept: "CSE", contestCreate: 5, problemCreate: 42, rating: "4.8", status: "Active", role: "HOD", lastActive: "Now" },
    { id: "F-1009", name: "Dr. Neha Gupta", email: "neha@xyz.edu", type: "faculty", designation: "Asst. Prof", dept: "Mathematics", contestCreate: 2, problemCreate: 12, rating: "4.5", status: "Active", role: "Instructor", lastActive: "3 days ago" },
    { id: "F-1012", name: "Prof. Rajesh Iyer", email: "rajesh@xyz.edu", type: "faculty", designation: "Lecturer", dept: "Mechanical", contestCreate: 8, problemCreate: 55, rating: "4.9", status: "Active", role: "Admin", lastActive: "1 hour ago" }
];

let requests = JSON.parse(localStorage.getItem('campusRequests')) || [
    { id: "REQ-F-901", name: "Dr. Anjali Verma", email: "anjali@xyz.edu", type: "faculty", designation: "Asst. Prof", dept: "IT", role: "Instructor", date: "2025-05-15", status: "Pending" },
    { id: "REQ-S-442", name: "Karan Johar", email: "karan@xyz.edu", type: "student", program: "BCA", branch: "Computer App", year: "2", sec: "A", date: "2025-05-16", status: "Pending" },
    { id: "REQ-S-771", name: "Ishita Bhalla", email: "ishita@xyz.edu", type: "student", program: "B.Tech", branch: "ECE", year: "3", sec: "B", date: "2025-05-17", status: "Pending" },
    { id: "REQ-F-332", name: "Dr. Sameer Khan", email: "sameer@xyz.edu", type: "faculty", designation: "Professor", dept: "AI & ML", role: "Instructor", date: "2025-05-18", status: "Pending" },
    { id: "REQ-S-119", name: "Varun Dhawan", email: "varun@xyz.edu", type: "student", program: "B.Tech", branch: "CS", year: "4", sec: "D", date: "2025-05-19", status: "Pending" },
    { id: "REQ-S-550", name: "Aditi Rao", email: "aditi@xyz.edu", type: "student", program: "B.Tech", branch: "CSE", year: "2", sec: "C", date: "2025-05-20", status: "Pending" },
    { id: "REQ-F-102", name: "Prof. Michael Scott", email: "michael@xyz.edu", type: "faculty", designation: "HOD", dept: "Management", role: "Admin", date: "2025-05-21", status: "Pending" },
    { id: "REQ-S-882", name: "Kabir Singh", email: "kabir@xyz.edu", type: "student", program: "M.Tech", branch: "Data Science", year: "1", sec: "A", date: "2025-05-22", status: "Pending" },
    { id: "REQ-F-404", name: "Dr. Elena Gilbert", email: "elena@xyz.edu", type: "faculty", designation: "Lecturer", dept: "Biology", role: "Instructor", date: "2025-05-23", status: "Pending" },
    { id: "REQ-S-221", name: "Sherlock Holmes", email: "detective@xyz.edu", type: "student", program: "B.Tech", branch: "Cyber Security", year: "3", sec: "B", date: "2025-05-24", status: "Pending" }
];

function updateData() {
    localStorage.setItem('campusUsers', JSON.stringify(users));
    localStorage.setItem('campusRequests', JSON.stringify(requests));
    const pendingCount = requests.filter(r => r.status === "Pending").length;
    const badge = document.getElementById('requestBadge');
    badge.innerText = pendingCount;
    badge.style.display = pendingCount > 0 ? 'inline-block' : 'none';
    render();
}

function setTab(tab) {
    activeTab = tab;
    const onboardBtn = document.getElementById('onboardBtn');
    if (tab === 'requests') {
        onboardBtn.style.display = 'none';
    } else {
        onboardBtn.style.display = 'block';
    }

    ['tabStudent', 'tabFaculty', 'tabRequests'].forEach(id => {
        document.getElementById(id).className = id.toLowerCase().includes(tab) ? 
        'px-10 py-3 rounded-xl text-sm font-bold transition-all tab-active' : 'px-10 py-3 rounded-xl text-sm font-bold text-gray-500 transition-all';
    });
    render();
}

function updateModalFields() {
    const container = document.getElementById('modalFields');
    if (modalUserType === 'student') {
        container.innerHTML = `
            <input id="newName" type="text" placeholder="Full Name" class="p-3 rounded-xl border border-theme-default bg-transparent text-sm dark:text-white outline-none">
            <input id="newEmail" type="email" placeholder="Email" class="p-3 rounded-xl border border-theme-default bg-transparent text-sm dark:text-white outline-none">
            <input id="newId" type="text" placeholder="ID Number" class="p-3 rounded-xl border border-theme-default bg-transparent text-sm dark:text-white outline-none">
            <input id="newProgram" type="text" placeholder="Program" class="p-3 rounded-xl border border-theme-default bg-transparent text-sm dark:text-white outline-none">
            <input id="newYear" type="text" placeholder="Year" class="p-3 rounded-xl border border-theme-default bg-transparent text-sm dark:text-white outline-none">
            <input id="newBranch" type="text" placeholder="Branch" class="p-3 rounded-xl border border-theme-default bg-transparent text-sm dark:text-white outline-none">
            <input id="newSec" type="text" placeholder="Section" class="p-3 rounded-xl border border-theme-default bg-transparent text-sm dark:text-white outline-none">
        `;
    } else {
        container.innerHTML = `
            <input id="newName" type="text" placeholder="Full Name" class="p-3 rounded-xl border border-theme-default bg-transparent text-sm dark:text-white outline-none">
            <input id="newEmail" type="email" placeholder="Email" class="p-3 rounded-xl border border-theme-default bg-transparent text-sm dark:text-white outline-none">
            <input id="newId" type="text" placeholder="Faculty ID" class="p-3 rounded-xl border border-theme-default bg-transparent text-sm dark:text-white outline-none">
            <input id="newDesig" type="text" placeholder="Designation" class="p-3 rounded-xl border border-theme-default bg-transparent text-sm dark:text-white outline-none">
            <input id="newDept" type="text" placeholder="Department" class="p-3 rounded-xl border border-theme-default bg-transparent text-sm dark:text-white outline-none">
            <input id="newRole" type="text" placeholder="Role" class="p-3 rounded-xl border border-theme-default bg-transparent text-sm dark:text-white outline-none">
        `;
    }
}

function saveUser() {
    let data = { type: modalUserType, id: document.getElementById('newId').value, name: document.getElementById('newName').value, email: document.getElementById('newEmail').value, lastActive: "Just now" };
    if(!data.name || !data.id) return alert("Missing ID or Name");
    
    if (modalUserType === 'student') {
        Object.assign(data, {
            program: document.getElementById('newProgram').value, year: document.getElementById('newYear').value, 
            branch: document.getElementById('newBranch').value, sec: document.getElementById('newSec').value,
            contest: 0, solved: 0, won: 0, streak: 0, collegeRank: '-', globalRank: '-', level: 1, accuracy: '0%'
        });
    } else {
        Object.assign(data, {
            designation: document.getElementById('newDesig').value, dept: document.getElementById('newDept').value,
            contestCreate: 0, problemCreate: 0, rating: "0.0", status: "Active", role: document.getElementById('newRole').value
        });
    }
    users.push(data);
    updateData();
    closeAddModal();
}

function render() {
    const thead = document.getElementById('tableHead');
    const tbody = document.getElementById('userTableBody');
    const search = document.getElementById('searchInput').value.toLowerCase();
    
    if (activeTab === 'student') {
        thead.innerHTML = `<tr><th class="px-8 py-4">Student Info</th><th class="px-4 py-4">Email</th><th class="px-4 py-4">Academic</th><th class="px-4 py-4 text-center">Contests</th><th class="px-4 py-4 text-center">Solved</th><th class="px-4 py-4 text-center">Won</th><th class="px-4 py-4 text-center text-orange-500">Streak</th><th class="px-4 py-4">College Rank</th><th class="px-4 py-4">Global Rank</th><th class="px-4 py-4 text-center">Level</th><th class="px-4 py-4">Active</th><th class="px-8 py-4 text-right">Actions</th></tr>`;
    } else if (activeTab === 'faculty') {
        thead.innerHTML = `<tr><th class="px-8 py-4">Faculty Info</th><th class="px-4 py-4">Email</th><th class="px-4 py-4">Designation</th><th class="px-4 py-4">Dept</th><th class="px-4 py-4 text-center">Contest Create</th><th class="px-4 py-4 text-center">Problem Create</th><th class="px-4 py-4 text-center">Rating</th><th class="px-4 py-4">Status</th><th class="px-4 py-4">Role</th><th class="px-4 py-4">Active</th><th class="px-8 py-4 text-right">Actions</th></tr>`;
    } else {
        thead.innerHTML = `<tr><th class="px-8 py-4">Applicant</th><th class="px-4 py-4">Email</th><th class="px-4 py-4">Type</th><th class="px-4 py-4">Professional Details</th><th class="px-4 py-4">Req. Date</th><th class="px-4 py-4">Status</th><th class="px-8 py-4 text-right">Action</th></tr>`;
    }

    let list = activeTab === 'requests' ? requests : users.filter(u => u.type === activeTab);
    let filtered = list.filter(u => (u.name || "").toLowerCase().includes(search) || (u.id || "").toLowerCase().includes(search));
    
    tbody.innerHTML = '';
    if(filtered.length === 0) { document.getElementById('emptyState').classList.remove('hidden'); return; }
    document.getElementById('emptyState').classList.add('hidden');

    filtered.forEach((u, i) => {
        let nameIcon = (u.name && u.name.length > 0) ? u.name[0] : '?';
        let row = `<tr class="hover:bg-blue-50/50 dark:hover:bg-blue-900/10 border-b border-theme-default text-xs">
            <td class="px-8 py-4 flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-primary-500 text-white flex items-center justify-center font-bold text-[10px]">${nameIcon}</div>
                <div><p class="font-bold dark:text-white">${u.name || 'Unknown'}</p><p class="text-[9px] text-primary-500 font-bold uppercase">${u.id || 'N/A'}</p></div>
            </td>
            <td class="px-4 py-4 text-gray-500">${u.email || 'N/A'}</td>`;

        if (activeTab === 'student') {
            row += `<td class="px-4 py-4 dark:text-gray-300 font-medium">${u.program || ''} • ${u.branch || ''}<br><span class="text-[9px] text-gray-400">Yr ${u.year || ''} • Sec ${u.sec || ''}</span></td>
                    <td class="px-4 py-4 text-center font-bold">${u.contest || 0}</td>
                    <td class="px-4 py-4 text-center font-bold">${u.solved || 0}</td>
                    <td class="px-4 py-4 text-center font-bold">${u.won || 0}</td>
                    <td class="px-4 py-4 text-center font-bold text-orange-500"><i class="fas fa-fire mr-1"></i>${u.streak || 0}</td>
                    <td class="px-4 py-4 font-bold">#${u.collegeRank || '-'}</td>
                    <td class="px-4 py-4 font-bold text-gray-400">#${u.globalRank || '-'}</td>
                    <td class="px-4 py-4 text-center"><span class="px-2 py-0.5 bg-primary-100 text-primary-700 rounded text-[9px] font-black">LVL ${u.level || 1}</span></td>
                    <td class="px-4 py-4 text-gray-400 text-[10px]">${u.lastActive || 'Just now'}</td>
                    <td class="px-8 py-4 text-right"><button onclick="deleteUser(${i})" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></button></td>`;
        } else if (activeTab === 'faculty') {
            row += `<td class="px-4 py-4 dark:text-gray-300 font-bold">${u.designation || 'Faculty'}</td>
                    <td class="px-4 py-4 dark:text-gray-300">${u.dept || 'N/A'}</td>
                    <td class="px-4 py-4 text-center font-bold text-blue-500">${u.contestCreate || 0}</td>
                    <td class="px-4 py-4 text-center font-bold text-green-500">${u.problemCreate || 0}</td>
                    <td class="px-4 py-4 text-center text-orange-500 font-bold"><i class="fas fa-star mr-1"></i>${u.rating || '0.0'}</td>
                    <td class="px-4 py-4"><span class="px-2 py-0.5 bg-green-100 text-green-700 rounded text-[9px] font-bold uppercase">${u.status || 'Active'}</span></td>
                    <td class="px-4 py-4 font-bold text-primary-500">${u.role || 'Instructor'}</td>
                    <td class="px-4 py-4 text-gray-400 text-[10px]">${u.lastActive || 'Just now'}</td>
                    <td class="px-8 py-4 text-right"><button onclick="deleteUser(${i})" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></button></td>`;
        } else {
            let detailLine = u.type === 'student' ? `${u.program} | ${u.branch}` : `${u.designation} | ${u.dept}`;
            let currentStatus = u.status || "Pending";
            let statusColor = currentStatus === "Approved" ? "text-green-500" : currentStatus === "Rejected" ? "text-red-500" : "text-orange-500";
            
            row += `<td class="px-4 py-4"><span class="px-2 py-1 ${u.type === 'faculty' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'} rounded font-black uppercase text-[8px]">${u.type}</span></td>
                    <td class="px-4 py-4 dark:text-gray-300 font-medium italic">${detailLine}</td>
                    <td class="px-4 py-4 text-gray-400">${u.date || 'N/A'}</td>
                    <td class="px-4 py-4 font-bold ${statusColor}">${currentStatus}</td>
                    <td class="px-8 py-4 text-right flex justify-end gap-2">
                        ${currentStatus === "Pending" ? `
                        <button onclick="handleRequest(${i}, 'approve')" class="px-4 py-1.5 bg-primary-500 text-white rounded-xl text-[10px] font-bold shadow-md hover:bg-primary-600">Approve</button>
                        <button onclick="handleRequest(${i}, 'reject')" class="px-4 py-1.5 bg-gray-100 text-red-600 rounded-xl text-[10px] font-bold hover:bg-red-50 transition-all">Reject</button>
                        ` : `<span class="text-[10px] text-gray-400 italic">History Saved</span>`}
                    </td>`;
        }
        row += `</tr>`;
        tbody.innerHTML += row;
    });
}

function handleRequest(idx, action) {
    const search = document.getElementById('searchInput').value.toLowerCase();
    let list = requests;
    let filtered = list.filter(u => (u.name || "").toLowerCase().includes(search) || (u.id || "").toLowerCase().includes(search));
    let target = filtered[idx];
    let actualIdx = requests.findIndex(r => r.id === target.id);

    if(action === 'approve') {
        requests[actualIdx].status = "Approved";
        let req = requests[actualIdx];
        let approvedUser = { ...req, lastActive: "Just now", status: "Active" };
        
        delete approvedUser.date;
        if(req.type === 'faculty') {
            Object.assign(approvedUser, { contestCreate: 0, problemCreate: 0, rating: "0.0" });
        } else {
            Object.assign(approvedUser, { contest:0, solved:0, won:0, level:1, streak:0, collegeRank:'-', globalRank:'-', accuracy:'0%' });
        }
        
        if(!users.some(u => u.id === approvedUser.id)) {
            users.push(approvedUser);
        }
    } else {
        requests[actualIdx].status = "Rejected";
    }
    updateData();
}

function deleteUser(idx) {
    if(!confirm("Delete user?")) return;
    const filtered = users.filter(u => u.type === activeTab);
    const actualIdx = users.indexOf(filtered[idx]);
    users.splice(actualIdx, 1);
    updateData();
}

function handleExcelUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
        try {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
            jsonData.forEach(row => {
                users.push({ type: activeTab, id: row.id || "ID-"+Date.now(), name: row.name || "New User", email: row.email || "N/A", lastActive: "Just now" });
            });
            updateData();
        } catch (error) { alert("Error reading file."); }
    };
    reader.readAsArrayBuffer(file);
}

function exportToExcel() {
    let list = activeTab === 'requests' ? requests : users.filter(u => u.type === activeTab);
    const ws = XLSX.utils.json_to_sheet(list);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, activeTab);
    XLSX.writeFile(wb, `Export_${activeTab}.xlsx`);
}

function openAddModal() { updateModalFields(); document.getElementById("addModal").classList.replace("hidden", "flex"); }
function closeAddModal() { document.getElementById("addModal").classList.replace("flex", "hidden"); }
function setModalUserType(t) { 
    modalUserType = t; 
    document.getElementById('modalTabStudent').className = t === 'student' ? 'flex-1 py-2 text-xs font-bold rounded-lg modal-tab-active' : 'flex-1 py-2 text-xs font-bold rounded-lg text-gray-500';
    document.getElementById('modalTabFaculty').className = t === 'faculty' ? 'flex-1 py-2 text-xs font-bold rounded-lg modal-tab-active' : 'flex-1 py-2 text-xs font-bold rounded-lg text-gray-500';
    updateModalFields();
}

document.addEventListener('DOMContentLoaded', updateData);
</script>
</body>
</html>